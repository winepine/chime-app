<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amazon Chime SDK Example</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.15/dist/tailwind.min.css" rel="stylesheet">
  <style>
    #video-section {
      /* height: 100vh; */
    }

    video {
      
      /* height: 100vh !important; */
    }
    #video-tile-self {
    min-width: 100%; 
    min-height: 100%;
    width: auto; 
    height: auto; 
    background-size: cover;
    overflow: hidden;
}
    #videoDemo {
      height: 70vh !important;
    }
  </style>
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.843.0.min.js"></script>
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.843.0.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
  <script src="./amazon-chime-sdk.min.js"></script>
  <script src="https://kit.fontawesome.com/a926154df8.js" crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.15/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="flex justify-center" onload="checkLocalDevice()">
  <div class="fixed top-0 pt-10 left-0 bg-white shadow-xl w-full h-full  z-30  " id="popupConnect">
    <div class="max-w-xl mx-auto py-4 px-6 text-center">
      <h2 class="text-lg font-semibold text-center">Please allow camera and audio to continue</h2>
      <p class="text-sm">We need to access your camera and microphone to provide the best possible experience.</p>

      <div class="flex justify-center mt-4">
        <video playsinline autoplay muted class="rounded-md" width="100%" height="auto" muted id="videoDemo">
      </div>
      <div class="flex justify-center mt-4">
        <button id="muteAudioButton" class="btn h-12 btn-primary px-4 py-2  bg-gray-300 text-black rounded-full ml-2"
          id="audioTrackIconUnMute">
          <i class="fa-solid fa-microphone" id="audioTrackIconUnMute"></i>
          <i class="fa-solid fa-microphone-slash hidden" id="audioTrackIconMute"></i>
        </button>
        <button id="muteVideoButton" class="btn  h-12  btn-primary  px-4 py-2  bg-gray-300 text-black rounded-full ml-2">
          <i class="fa-solid fa-video" id="videoTrackIconUnMute"></i>
          <i class="fa-solid fa-video-slash hidden" id="videoTrackIconMute"></i>
        </button>
      </div>
      <div class="flex justify-center mt-10 w-full">
        <div class="flex flex-col  w-full">
          <div class="flex flex-row justify-center w-full">
            <button onclick="createMeeting()" id="meetingCreate"
              class="btn text-sm btn-outline-secondary mx-5 bg-gray-300 text-black text-center border-radius rounded w-1/2  px-2 py-2 "> <i class="fa-solid fa-add mr-5"></i>Create Meeting</button>
            <button onclick="createMeeting()"  id="meetingJoin"
              class="btn hidden text-sm btn-outline-secondary mx-5 bg-green-700 text-white text-center border-radius rounded w-1/2  px-2 py-2 "> <i class="fa-regular fa-handshake mr-5"> </i>Join Meeting</button>
           
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="fixed z-10 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
      <div class="inline-block bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all align-middle w-[32rem] my-10" style="height: 90vh; min-width: 32rem;">
        <div class="absolute h-60 top-5 right-5 rounded-md z-10">
          <video id="video-tile-self" class="w-full h-full rounded-md" src=""></video>
          <!-- <table id="remoteVidTbl" class="w-full h-full rounded-md"> -->
            <!-- <tr></tr> -->
          <!-- </table> -->
        </div>
        <div class="relative w-full h-full">
          <video id="video-tile-other" style="width: 100%; height: 100%; display: none;" src=""></video>
          <p id="timer" class="w-40 font-normal text-lg text-white ml-5 pt-5">00:00:00</p>
          <div style="background-color: transparent;" class="absolute bottom-0 z-50 left-0 right-0 bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
            
            <div class="flex justify-center w-full">
              <button onclick="copyToClipboard()"
              class="btn h-12 btn-primary px-4 py-2  bg-white text-black rounded-full">
              <i class="fa-solid fa-copy"></i>
          </button>
              <button onclick="audioControl()" id="muteAudioButtonCall"
            class="btn h-12 btn-primary px-4 py-2  bg-white text-black rounded-full ml-2">
            <i class="fa-solid fa-microphone" id="audioTrackIconUnMuteCall"></i>
            <i class="fa-solid fa-microphone-slash hidden" id="audioTrackIconMuteCall"></i>
          </button>
          <button onclick="videoControl()" id="muteVideoButtonCall"
            class="btn  h-12  btn-primary  px-4 py-2  bg-white text-black rounded-full ml-2">
            <i class="fa-solid fa-video" id="videoTrackIconUnMuteCall"></i>
            <i class="fa-solid fa-video-slash hidden" id="videoTrackIconMuteCall"></i>
          </button>
          <button onclick="endCall()" class="btn btn-primary px-4 py-2 h-12 bg-red-700 text-white rounded-full ml-2">
            <i class="fa-solid fa-phone-slash"></i>
          </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <audio id="audio" crossorigin="anonymous" autoplay="autoplay"></audio>
  </div>
  
  
<!-- ----------------- -->
  <div id="errorCam"
    class="hidden bg-opacity-30 fixed left-0 top-0 w-full h-full bg-gray-900 z-20 justify-center items-end text-end flex">
    <div class="bg-red-900 w-full py-2 px-5 flex justify-center items-center">
      <p class="text-white p-5 flex justify-center items-center"><i
          class="fa-solid text-2xl fa-circle-exclamation pr-5"></i>Cannot access media device Camera / Audio. Please
        check the device setting and reload the page</p>
      <button onclick="window.location.reload()" class="text-red-900 rounded bg-white  text-lg p-2"><i
          class="fa-solid fa-rotate-right"></i> Reload</button>
    </div>
  </div>
  <div id="errorInfo"
    class="hidden bg-opacity-30 fixed left-0 top-0 w-full h-full bg-gray-900 z-20 justify-center items-end text-end flex">
    <div class="bg-red-900 w-full py-2 px-5 flex justify-center items-center">
      <p class="text-white p-5 flex justify-center items-center"><i
          class="fa-solid text-2xl fa-circle-exclamation pr-5"></i>
        <span id="error_msg"></span></p>
      <button onclick="window.location.reload()" class="text-red-900 rounded bg-white  text-lg p-2"><i
          class="fa-solid fa-rotate-right"></i> Reload</button>
    </div>
  </div>
  <div class="bg-opacity-50 hidden fixed left-0 top-0 w-full h-full bg-gray-900 z-50 justify-center items-center text-center flex" id="loading">
    <img src="loading.gif" class="w-40">
  </div>
  <div id="messageDiv" class="fixed text-center z-30 bottom-0 left-0 right-0 p-4 bg-black text-white transform translate-y-full w-full transition-all duration-500">
    Copied to Clipboard
  </div>
  <script>
    var audioTrack = false
    var videoTrack = false
    const muteAudioButton = document.getElementById("muteAudioButton");
    const muteVideoButton = document.getElementById("muteVideoButton");
    const muteAudioButtonCall = document.getElementById("muteAudioButtonCall");
    const muteVideoButtonCall = document.getElementById("muteVideoButtonCall");
    var hours = 0;
    var minutes = 0;
    var seconds = 0;
    var timer;
    const baseURL = window.location.origin
    var meetingSession;
    const logger = new ChimeSDK.ConsoleLogger("MyLogger");
    const videoElementSelf = document.getElementById("video-tile-self");
    var tries = 0
    const meetingInfo = {}
    var visitor = false
    if(window.location.search && window.location.search != ''){
      meetingInfo.Meeting = JSON.parse(atob(window.location.search.replace('?meetingInfo=','')))
      visitor = true
      document.getElementById('meetingCreate').classList.add('hidden')
      document.getElementById('meetingJoin').classList.remove('hidden')
    }
      
    //console.log(meetingInfo)
    var copyToClipboard = () => {
      const dummyElement = document.createElement('textarea');
      dummyElement.value = `https://winepine.github.io/chime-app/public/?meetingInfo=${btoa(JSON.stringify(meetingInfo.Meeting))}`;
      document.body.appendChild(dummyElement);
      dummyElement.select();
      document.execCommand('copy');
      document.body.removeChild(dummyElement);
      setTimeout(r=>{
        document.getElementById('messageDiv').classList.remove('translate-y-neg-40')
        document.getElementById('messageDiv').classList.add('translate-y-full')
      },2000)
      document.getElementById('messageDiv').classList.add('translate-y-neg-40')
      document.getElementById('messageDiv').classList.remove('translate-y-full')
    }
    var startTimer = () => {
      timer = setInterval(updateTimer, 1000);
    }

    var stopTimer = () => {
      clearInterval(timer);
    }

    var resetTimer = () => {
      hours = 0;
      minutes = 0;
      seconds = 0;
      updateDisplay();
    }

    var updateTimer = () => {
      seconds++;
      if (seconds >= 60) {
        seconds = 0;
        minutes++;
        if (minutes >= 60) {
          minutes = 0;
          hours++;
        }
      }
      updateDisplay();
    }

    var updateDisplay = () => {
      var formattedTime = pad(hours) + ":" + pad(minutes) + ":" + pad(seconds);
      document.getElementById("timer").innerHTML = formattedTime;
    }

    var pad = (value) => {
      return value < 10 ? "0" + value : value;
    }
    muteAudioButton.addEventListener("click", () => {
      audioTrack.enabled = !audioTrack.enabled;
      setAudioAction()
    });
    muteVideoButton.addEventListener("click", () => {
      videoTrack.enabled = !videoTrack.enabled;
      setVideoAction()

    });
    var setAudioAction = () => {
      if (audioTrack.enabled) {
        if (document.getElementById('audioTrackIconMute')) {
          document.getElementById('audioTrackIconMute').style.display = 'none'
          document.getElementById('audioTrackIconUnMute').style.display = 'block'
        }
        document.getElementById('audioTrackIconMuteCall').style.display = 'none'
        document.getElementById('audioTrackIconUnMuteCall').style.display = 'block'
      } else {
        if (document.getElementById('audioTrackIconMute')) {
          document.getElementById('audioTrackIconMute').style.display = 'block'
          document.getElementById('audioTrackIconUnMute').style.display = 'none'
        }
        document.getElementById('audioTrackIconMuteCall').style.display = 'block'
        document.getElementById('audioTrackIconUnMuteCall').style.display = 'none'
      }
    }
    var setVideoAction = () => {
      if (videoTrack.enabled) {
        if (document.getElementById('videoTrackIconMute')) {
          document.getElementById('videoTrackIconMute').style.display = 'none'
          document.getElementById('videoTrackIconUnMute').style.display = 'block'
        }
        document.getElementById('videoTrackIconMuteCall').style.display = 'none'
        document.getElementById('videoTrackIconUnMuteCall').style.display = 'block'
      } else {
        if (document.getElementById('videoTrackIconMute')) {
          document.getElementById('videoTrackIconMute').style.display = 'block'
          document.getElementById('videoTrackIconUnMute').style.display = 'none'
        }
        document.getElementById('videoTrackIconMuteCall').style.display = 'block'
        document.getElementById('videoTrackIconUnMuteCall').style.display = 'none'
      }
    }
    
    const createAttendee = async (meeting) => {
      const options = {
        method: "GET",
        cache: 'no-cache',
        headers: {
          "Content-Type": "application/json",
        },
      };
      const url = `https://3d25c4zagsgrtucinslm23w3xu0hlmiu.lambda-url.us-east-1.on.aws` + `/createAttendee?id=${meeting.MeetingId}`;
      try {
        const response = await fetch(url, options);
        if (!response.ok) {
          const eror = await response.json()
          throw new Error(eror.message);
        }
        var res = await response.json();
        if(!res.Attendee){
          throw new Error("Attendee creation failed at server side.");
        }
        meetingInfo.Attendee = res.Attendee
        startMeeting()
      } catch (error) {
        document.getElementById('errorInfo').classList.remove('hidden')
        document.getElementById('error_msg').innerText = "Error Creating Attendee /  " + error
      }
    }
    var createMeeting = async () => {
      document.getElementById('meetingCreate').innerText='Creating Meeting...'
      
      document.getElementById('loading').classList.remove('hidden')
      if(visitor){
        createAttendee(meetingInfo.Meeting)
        return
      }
      const options = {
        method: "GET",
        cache: 'no-cache',
        headers: {
          "Content-Type": "application/json",
        },
      };
      const url = `https://3d25c4zagsgrtucinslm23w3xu0hlmiu.lambda-url.us-east-1.on.aws` + "/createMeeting";
      try {
        const response = await fetch(url, options);
        if (!response.ok) {
          const eror = await response.json()
          throw new Error(eror.message);
        }
        var res = await response.json();
        if(!res.Meeting){
          throw new Error("Meeting creation failed at server side.");
        }
        meetingInfo.Meeting = res.Meeting
        createAttendee(res.Meeting)
      } catch (error) {
        document.getElementById('errorInfo').classList.remove('hidden')
        document.getElementById('error_msg').innerText = "Error Creating Meeting /  " + error
      }
    }
    var checkLocalDevice = () => {
      const video = document.getElementById("videoDemo");
      const constraints = {
        video: {width: 180, height: 320},
        audio: true,
      };
      navigator.mediaDevices
        .getUserMedia(constraints)
        .then(stream => {
          audioTrack = stream.getAudioTracks()[0];
          videoTrack = stream.getVideoTracks()[0];
          console.log(audioTrack, videoTrack)
          video.srcObject = stream;
        })
        .catch(error => {
          console.error(error)
          document.getElementById('errorCam').classList.remove('hidden')
        })
    }
    
    async function startMeeting() {
      document.getElementById('popupConnect').remove()
      document.getElementById('loading').classList.add('hidden')
      const meeting = meetingInfo.Meeting;
      const attendee = meetingInfo.Attendee;

      const deviceController = new ChimeSDK.DefaultDeviceController(logger);
      //console.log("deviceController", deviceController);
      const configuration = new ChimeSDK.MeetingSessionConfiguration(
        meeting,
        attendee
      );
      //console.log("configuration ", configuration);
      meetingSession = new ChimeSDK.DefaultMeetingSession(
        configuration,
        logger,
        deviceController
      );

      //console.log("meetingSession ", meetingSession);
      const presentAttendeeId = meetingSession.configuration.credentials.attendeeId;
      //console.log("presentAttendeeId - ", presentAttendeeId);
      const browserBehaviour = new ChimeSDK.DefaultBrowserBehavior();
      //console.log("supportSetSinkId is ", browserBehaviour.supportsSetSinkId());

      await initLocalDevices();
    }
    async function hideCamera() {
      await meetingSession.audioVideo.stopVideoInput();
    }
    async function initLocalDevices() {
      try {
        const videoInputs = await meetingSession.audioVideo.listVideoInputDevices();
        for (let i = 0; i < videoInputs.length; i++) {
          const option = document.createElement("option");
          option.text = videoInputs[i].label || "Audio-in \${i + 1}";
          option.value = videoInputs[i].deviceId;
        }

        if (videoInputs[0] && videoInputs[0].deviceId != "") {
          await meetingSession.audioVideo.chooseVideoInputQuality(
            "180",
            "320",
            "15"
          ); // 540p 15fps
          await meetingSession.audioVideo.setVideoMaxBandwidthKbps(1400);
          await meetingSession.audioVideo.startVideoInput(videoInputs[0].deviceId); // Selecting the first camera device for simplicity v3
          const qualitySetting =
            await meetingSession.audioVideo.getVideoInputQualitySettings();
          //console.log("video quality publishing is ", qualitySetting);
        } else {
          await meetingSession.audioVideo.stopVideoInput();
          //console.log("empty set for chooseVideoInputDevice");
        }

        // microphone
        const audioInputs = await meetingSession.audioVideo.listAudioInputDevices();
        if (audioInputs[0] && audioInputs[0].deviceId != "") {
          await meetingSession.audioVideo.startAudioInput(audioInputs[0].deviceId);
        } else if (audioInputs[0] && audioInputs[0].groupId != "") {
          await meetingSession.audioVideo.startAudioInput(audioInputs[0].groupId);
        } else {
          await meetingSession.audioVideo.startAudioInput(null);
        }

      } catch (err) {
        //console.log("Try Catch Error - unable to acquire device - ", err);
      }

      await meetingSession.audioVideo.startVideoPreviewForVideoInput(videoElementSelf);
      joinMeeting()

    }

    async function joinMeeting() {
      await meetingSession.audioVideo.stopVideoPreviewForVideoInput(videoElementSelf);
      const audioOutputElement = document.getElementById("audio");
      try {
        await meetingSession.audioVideo.bindAudioElement(audioOutputElement);
      } catch (e) {
        //console.log("Failed to bindAudioElement ", e);
      }
      const observer = {
        audioVideoDidStart: () => {
          logger.debug("Started");
          //console.log("audioVideoDidStart fired");
          startTimer()
          meetingSession.audioVideo.startLocalVideoTile();
          if (!videoTrack.enabled) {
            const localVideoTile = meetingSession.audioVideo.getLocalVideoTile();
            //console.log(localVideoTile)
            localVideoTile.pause();
          }
          if (!audioTrack.enabled) {
            meetingSession.audioVideo.realtimeMuteLocalAudio();
          }
        },
        videoTileDidUpdate: (tileState) => {
          //console.log("videoTileDidUpdate fired", tileState);
          if (!tileState.boundAttendeeId) {
            return;
          }
          if (tileState.localTile) {
            meetingSession.audioVideo.bindVideoElement(
              tileState.tileId,
              videoElementSelf
            );
            //console.log("local tile");
          } else {
            const videoElementNew = document.getElementById('video-tile-other');
            meetingSession.audioVideo.bindVideoElement(
              tileState.tileId,
              videoElementNew
            );
            videoElementNew.style.display = "block";
          }
        },
        videoTileWasRemoved: (tileId) => {
          const videoElementRemoved = document.getElementById('video-tile-other');
          if (videoElementRemoved)
            videoElementRemoved.style.display = "none";
        },
        audioVideoDidStop: async (sessionStatus) => {
          await meetingSession.audioVideo.stopAudioInput();

          // Or use the destroy API to call stopAudioInput and stopVideoInput.
          meetingSession.deviceController.destroy();
        },
      };

      meetingSession.audioVideo.addObserver(observer);
      meetingSession.audioVideo.start();
      meetingSession.audioVideo.stopLocalVideoTile();

    }
    var audioControl = () => {
      audioTrack.enabled = !audioTrack.enabled;
      if (audioTrack.enabled) {
        meetingSession.audioVideo.realtimeUnmuteLocalAudio();
      } else {
        meetingSession.audioVideo.realtimeMuteLocalAudio();
      }
      setAudioAction()
    }
    var videoControl = async () => {
      videoTrack.enabled = !videoTrack.enabled;
      const localVideoTile = await meetingSession.audioVideo.listVideoInputDevices();
      // Pause the local video tile
      //console.log(localVideoTile)
      if (videoTrack.enabled) {
        //localVideoTile.unpause();
        await meetingSession.audioVideo.startVideoInput(localVideoTile[0].deviceId);
        meetingSession.audioVideo.startLocalVideoTile();
      } else {
        //localVideoTile.pause();
        hideCamera()
      }
      setVideoAction()
    }
    var endCall = () => {
      meetingSession.audioVideo.stop();
      window.location.reload()
    }
  </script>
</body>


</html>